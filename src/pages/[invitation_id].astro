---
import '../styles/index.css';

import Celebrate from '../components/Celebrate.astro';
import Family from '../components/Family.astro';
import RSVP from '../components/RSVP.astro';
import Location from '../components/Location.astro';
import Itinerary from '../components/Itinerary.astro';
import Dresscode from '../components/Dresscode.astro';
import Footer from '../components/Footer.astro';
import HeaderHero from '../components/HeaderHero.astro';

import { getSupabase } from '../lib/supabase';
import type { Database } from '@/lib/database.types';

const supabase = getSupabase();

const { invitation_id } = Astro.params;

// Get invitation with its guests
const { data: invitation } = await supabase
  .from('invitations')
  .select(
    `
    id,
    title,
    guests (
      id,
      name,
      rsvp,
      menu,
      is_special_guest
    )
  `
  )
  .eq('id', invitation_id)
  .single();

// If no invitation found, redirect to 404
if (!invitation) {
  return Astro.redirect('/404');
}

// Sort guests by name
const guests =
  (invitation.guests?.sort((a: { name: string }, b: { name: string }) =>
    a.name.localeCompare(b.name)
  ) as Database['public']['Tables']['guests']['Row'][]) || [];

const title = invitation.title;
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Welcome</title>
  </head>
  <body>
    <main>
      <HeaderHero />
      <Celebrate />
      <Family title={title} />
      <RSVP guests={guests} />
      <Location />
      <Itinerary />
      <Dresscode />
      <Footer />
    </main>
  </body>
</html>

<style>
  body {
    main {
      height: 100vh;
      width: 100%;
      display: grid;
      place-items: center;
      overflow-x: hidden;
      background-color: var(--white);

      header,
      section {
        max-width: 56rem;
        width: 100%;
      }

      .section-content {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4rem;
        height: 100%;
        width: 100%;
        padding: 5.6rem 4rem;
      }
    }
  }
</style>
