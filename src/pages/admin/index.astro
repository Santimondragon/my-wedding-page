---
import '../../styles/index.css';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { checkAuth } from '../../middleware/auth';
import { getSupabase } from '../../lib/supabase';
import AdminTabs from '../../components/react/AdminTabs';

const { isAuthorized } = await checkAuth(Astro);

if (!isAuthorized) {
  return Astro.redirect('/login');
}

// Get all invitations with their guests and statistics
const supabase = getSupabase();

// Invitations
const { data: invitationsData } = await supabase
  .from('invitations')
  .select(
    `
    id,
    custom_id,
    title,
    created_at,
    updated_at,
    is_special_invitation,
    is_sent,
    deadline,
    guests (
      id,
      name,
      rsvp,
      menu,
      created_at,
      updated_at,
      invitation_id,
      drink,
      table,
      table_seat
    )
  `
  )
  .order('created_at', { ascending: false });

const invitations = invitationsData || [];

// Flatten all guests from all invitations
const allGuests = invitations.flatMap((inv: any) =>
  (inv.guests || []).map((g: any) => ({
    ...g,
    invitation: {
      id: inv.id,
      title: inv.title,
      is_special_invitation: inv.is_special_invitation,
      is_sent: inv.is_sent,
      created_at: inv.created_at,
      updated_at: inv.updated_at,
      deadline: inv.deadline,
    },
  }))
);

// Guest stats
const totalGuests = allGuests.length;
const confirmedGuests = allGuests.filter((g: any) => g.rsvp === true).length;
const pendingGuests = allGuests.filter((g: any) => g.rsvp === null).length;
const declinedGuests = allGuests.filter((g: any) => g.rsvp === false).length;

const guestStats = {
  totalGuests,
  confirmedGuests,
  pendingGuests,
  declinedGuests,
};

// Invitation stats
const totalInvitations = invitations.length;
const invitationStats = {
  totalInvitations,
  totalGuests,
  confirmedGuests,
  pendingGuests,
};
---

<AdminLayout title="Manage Invitations">
  <AdminTabs
    client:load
    initialInvitations={invitations}
    initialStats={invitationStats}
    initialGuests={allGuests}
    guestStats={guestStats}
  />
</AdminLayout>
