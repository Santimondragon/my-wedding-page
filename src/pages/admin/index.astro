---
import '../../styles/index.css';
import AdminLayout from '../../layouts/AdminLayout.astro';
import { checkAuth } from '../../middleware/auth';
import { getSupabase } from '../../lib/supabase';
import InvitationManager from '../../components/react/InvitationManager';

const { isAuthorized } = await checkAuth(Astro);

if (!isAuthorized) {
  return Astro.redirect('/login');
}

// Get all invitations with their guests and statistics
const supabase = getSupabase();

const { data: invitationsData } = await supabase
  .from('invitations')
  .select(
    `
    id,
    title,
    created_at,
    updated_at,
    is_special_invitation,
    is_sent,
    deadline,
    guests (
      id,
      name,
      rsvp,
      menu
    )
  `
  )
  .order('created_at', { ascending: false });

const invitations = invitationsData || [];

// Calculate statistics
const totalInvitations = invitations.length;
const totalGuests = invitations.reduce((acc, inv) => acc + (inv.guests?.length || 0), 0);
const confirmedGuests = invitations.reduce(
  (acc, inv) => acc + (inv.guests?.filter((g: any) => g.rsvp === true).length || 0),
  0
);
const pendingGuests = invitations.reduce(
  (acc, inv) => acc + (inv.guests?.filter((g: any) => g.rsvp === null).length || 0),
  0
);

const stats = {
  totalInvitations,
  totalGuests,
  confirmedGuests,
  pendingGuests,
};
---

<AdminLayout title="Manage Invitations">
  <InvitationManager client:load initialInvitations={invitations} initialStats={stats} />
</AdminLayout>
